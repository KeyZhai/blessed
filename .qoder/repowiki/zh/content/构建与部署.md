# 构建与部署

<cite>
**Referenced Files in This Document**   
- [package.json](file://package.json)
- [next.config.ts](file://next.config.ts)
- [tsconfig.json](file://tsconfig.json)
- [config.ts](file://config.ts)
- [lib/redis.ts](file://lib/redis.ts)
- [app/[lng]/actions.ts](file://app/[lng]/actions.ts)
</cite>

## 目录
1. [构建与开发](#构建与开发)
2. [Next.js 配置扩展](#nextjs-配置扩展)
3. [TypeScript 编译配置](#typescript-编译配置)
4. [部署指南](#部署指南)
5. [常见问题排查](#常见问题排查)
6. [性能优化建议](#性能优化建议)

## 构建与开发

本项目基于 Next.js 框架构建，使用 pnpm 作为包管理工具。项目的构建与开发流程通过 `package.json` 中定义的脚本命令进行管理。

### 依赖安装
使用 pnpm 安装项目所需的所有依赖项：
```bash
pnpm install
```
此命令会根据 `pnpm-lock.yaml` 文件精确安装所有依赖，确保开发环境的一致性。

### 启动开发服务器
项目配置了使用 Turbopack 的开发服务器，可提供更快的热重载体验。启动开发服务器的命令如下：
```bash
pnpm dev
```
该命令会执行 `next dev --turbopack`，启动一个监听 `http://localhost:3000` 的开发服务器。Turbopack 作为 Webpack 的继任者，能显著提升大型项目的开发构建速度。

### 生产环境构建
在部署到生产环境前，需要执行生产构建以生成优化的静态文件：
```bash
pnpm build
```
此命令会执行 `next build --turbopack`，对应用进行静态优化、代码分割和资源压缩，生成的文件将存放在 `.next` 目录中，可供 `pnpm start` 命令启动生产服务器。

**Section sources**
- [package.json](file://package.json#L6-L11)

## Next.js 配置扩展

`next.config.ts` 文件是 Next.js 应用的核心配置文件。当前项目中的配置为空，但为未来的扩展提供了基础。

### 当前配置状态
目前的 `next.config.ts` 仅导出了一个空的 `NextConfig` 对象，这意味着应用将使用 Next.js 的所有默认配置。

### 潜在扩展方向
尽管当前配置为空，但该文件是进行高级配置的入口，可进行以下扩展：

- **环境变量配置**：通过 `env` 字段将环境变量注入到客户端代码中，例如配置 API 基础 URL 或功能开关。
- **自定义 Webpack 配置**：虽然 Next.js 默认隐藏了 Webpack 配置，但可以通过 `webpack` 字段进行自定义，例如添加新的加载器（loader）或插件（plugin）以支持特殊文件类型。
- **路由重写与重定向**：使用 `async redirects()` 或 `async rewrites()` 函数来定义复杂的路由规则，实现 URL 重写或跳转。
- **图像优化**：通过 `images` 字段配置图像优化服务，如指定远程图像域名以启用 `next/image` 组件的优化功能。
- **输出配置**：使用 `output` 字段指定为 `export` 以生成静态 HTML 文件，适用于部署到不支持 Node.js 的静态托管服务。

**Section sources**
- [next.config.ts](file://next.config.ts#L1-L8)

## TypeScript 编译配置

`tsconfig.json` 文件定义了项目的 TypeScript 编译选项，对代码的类型检查和编译行为有直接影响。

### 核心编译选项分析
- **`"strict": true`**：启用所有严格的类型检查选项，包括 `noImplicitAny`、`strictNullChecks` 等。这能最大程度地减少运行时错误，强制开发者明确处理 `null` 和 `undefined`，提高代码的健壮性。
- **`"target": "ES2017"`**：指定编译后的 JavaScript 目标版本。这决定了生成代码的语法特性，确保与目标运行环境（如现代浏览器或 Node.js 版本）兼容。
- **`"module": "esnext"`**：指定模块代码生成方式为 ES6 模块（ESM），这是现代 JavaScript 的标准模块系统，支持 Tree Shaking 等优化。
- **`"moduleResolution": "bundler"`**：采用打包器（如 Vite、Turbopack）的模块解析策略，与现代前端工具链保持一致，支持更灵活的导入路径。
- **`"noEmit": true`**：不生成输出文件。TypeScript 仅用于类型检查，实际的代码编译和打包由 Next.js 处理。这避免了双重编译，提高了构建效率。
- **`"jsx": "preserve"`**：保留 JSX 语法，交由后续的构建工具（如 Babel）处理，这是 Next.js 项目的标准配置。

### 路径映射
`"paths"` 字段定义了模块别名，例如 `@/components/*` 映射到 `components/*` 目录。这允许使用绝对路径导入，避免了冗长的相对路径（如 `../../../components`），提高了代码的可读性和可维护性。

**Section sources**
- [tsconfig.json](file://tsconfig.json#L1-L33)

## 部署指南

该项目可以轻松部署到 Vercel、Netlify 等现代化的前端托管平台。

### 部署到 Vercel
Vercel 是 Next.js 的创建者 Vercel 公司推出的平台，对 Next.js 应用有最佳支持。
1. 将代码推送到 GitHub 仓库。
2. 登录 Vercel 并导入该仓库。
3. Vercel 会自动检测到 `next.config.ts` 并配置为 Next.js 项目。
4. **构建命令**：`pnpm build`。
5. **输出目录**：`.next`。
6. **环境变量**：在项目设置中添加 `REDIS_URL` 环境变量，其值为 Redis 服务的连接字符串（如 `redis://default:password@host:port`）。

### 部署到 Netlify
Netlify 也支持 Next.js 应用的部署。
1. 连接 GitHub 仓库。
2. 在构建设置中，选择框架预设为 "Next.js"。
3. **构建命令**：`pnpm build`。
4. **发布目录**：`.next`。
5. **环境变量**：在 "Build & deploy" -> "Environment" 中设置 `REDIS_URL` 变量，确保其值与生产环境的 Redis 服务匹配。

**Section sources**
- [lib/redis.ts](file://lib/redis.ts#L1-L46)
- [config.ts](file://config.ts#L1-L3)

## 常见问题排查

在构建和运行过程中可能会遇到一些常见问题，以下是排查方法。

### 依赖冲突
使用 pnpm 时，如果出现模块找不到或版本冲突的错误，首先尝试清除缓存并重新安装：
```bash
pnpm store prune
pnpm install
```
如果问题依旧，检查 `package.json` 中的依赖版本是否与 `pnpm-lock.yaml` 冲突，必要时手动更新版本号。

### 类型检查失败
当 TypeScript 报错时，通常是由于 `tsconfig.json` 中启用了严格的类型检查。
- **错误信息**：仔细阅读编译器给出的错误信息，定位到具体的文件和行号。
- **类型定义**：对于第三方库，确保已安装对应的类型定义包（如 `@types/negotiator`）。
- **类型断言**：在必要时，可以使用 `as` 关键字进行类型断言，但应谨慎使用，避免掩盖潜在的类型错误。

### Redis 连接失败
应用通过 `ioredis` 连接 Redis 服务。如果出现连接错误：
- **环境变量**：确认 `REDIS_URL` 环境变量已正确设置，并且格式正确。
- **服务状态**：检查 Redis 服务是否正在运行，并且网络可达。
- **默认连接**：根据 `lib/redis.ts` 的代码，若未设置 `REDIS_URL`，`ioredis` 会尝试连接 `localhost:6379`。在生产环境中，这通常需要显式配置。

**Section sources**
- [lib/redis.ts](file://lib/redis.ts#L1-L46)
- [app/[lng]/actions.ts](file://app/[lng]/actions.ts#L1-L76)

## 性能优化建议

为了提升应用的性能和用户体验，可以考虑以下优化措施。

### 代码分割
Next.js 默认支持基于路由的代码分割。确保每个页面组件的代码是独立的，避免在 `layout.tsx` 中引入过大的库。对于非关键的第三方库，可以使用动态导入（`next/dynamic`）进行懒加载。

### 静态资源压缩
- **CSS**：`postcss.config.mjs` 文件表明项目使用 PostCSS。可以配置 `cssnano` 插件来压缩和优化 CSS 文件。
- **图像**：使用 `next/image` 组件替代原生 `<img>` 标签。它会自动进行图像优化，包括格式转换（如 WebP）、尺寸调整和懒加载。

### 缓存策略
- **服务端缓存**：`lib/redis.ts` 中的 `getAllNotes` 函数在 Redis 为空时会填充初始数据。可以扩展此逻辑，为频繁读取的数据设置更长的 TTL（Time To Live）。
- **客户端缓存**：利用 Next.js 的 `revalidatePath` 函数（在 `actions.ts` 中使用）来控制页面和布局的缓存失效，平衡性能和数据新鲜度。

**Section sources**
- [lib/redis.ts](file://lib/redis.ts#L14-L20)
- [app/[lng]/actions.ts](file://app/[lng]/actions.ts#L54-L55)
- [postcss.config.mjs](file://postcss.config.mjs#L1-L3)