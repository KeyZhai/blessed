# 国际化配置

<cite>
**Referenced Files in This Document**   
- [config.ts](file://config.ts)
- [app/i18n/index.ts](file://app/i18n/index.ts)
- [app/i18n/client.ts](file://app/i18n/client.ts)
- [app/i18n/locales/zh/basic.json](file://app/i18n/locales/zh/basic.json)
- [app/i18n/locales/en/basic.json](file://app/i18n/locales/en/basic.json)
</cite>

## 目录
1. [国际化配置](#国际化配置)
2. [语言支持范围与默认语言配置](#语言支持范围与默认语言配置)
3. [服务端i18next实例初始化](#服务端i18next实例初始化)
4. [核心配置项解析](#核心配置项解析)
5. [服务端翻译函数使用](#服务端翻译函数使用)
6. [预加载策略与性能优化](#预加载策略与性能优化)

## 语言支持范围与默认语言配置

项目通过 `config.ts` 文件集中管理国际化相关配置。该文件定义了两个关键常量：`locales` 和 `defaultLocale`，它们共同决定了应用的语言支持范围和默认语言选择。

`locales` 数组明确列出了应用支持的所有语言代码，当前配置为 `["zh", "en"]`，表示应用支持中文（zh）和英文（en）两种语言。这个列表是应用多语言功能的基石，所有后续的路由、资源加载和语言切换都基于此列表进行。

`defaultLocale` 常量则指定了当用户未明确选择语言或系统无法检测到用户偏好时，应用将使用的默认语言。在本项目中，`defaultLocale` 被设置为 `"zh"`，意味着中文是应用的默认语言。

**Section sources**
- [config.ts](file://config.ts#L0-L1)

## 服务端i18next实例初始化

`app/i18n/index.ts` 文件中的 `initI18next` 函数是服务端国际化功能的核心。该函数负责根据传入的语言参数动态创建并初始化一个独立的 i18next 实例。

该函数接受两个参数：`lng`（语言代码）和 `ns`（命名空间），并返回一个已准备就绪的 `i18n` 实例。其初始化流程如下：
1.  **创建实例**：调用 `createInstance()` 创建一个新的 i18next 实例，确保服务端渲染的每个请求都拥有独立的、无状态的语言环境，避免了不同用户请求之间的数据污染。
2.  **注册插件**：使用 `.use()` 方法注册了 `initReactI18next` 插件以支持 React 组件，以及 `resourcesToBackend` 插件来实现按需动态加载翻译资源。
3.  **动态资源加载**：`resourcesToBackend` 插件的加载器函数 `(language: string, namespace: string) => import(\`./locales/\${language}/\${namespace}.json\`)` 是实现按需加载的关键。它利用了 JavaScript 的动态导入（`import()`）特性，根据传入的 `language` 和 `namespace` 参数，精确地从 `app/i18n/locales/` 目录下加载对应的 JSON 文件，例如 `zh/basic.json` 或 `en/basic.json`。

**Section sources**
- [app/i18n/index.ts](file://app/i18n/index.ts#L16-L39)

## 核心配置项解析

`initI18next` 函数在初始化 i18next 实例时，通过 `init()` 方法传入了一系列核心配置项，这些配置项深刻影响着多语言路由和页面渲染的行为。

```mermaid
flowchart TD
A[initI18next 函数调用] --> B[创建 i18next 实例]
B --> C[注册 initReactI18next 插件]
C --> D[注册 resourcesToBackend 插件]
D --> E[执行 init() 初始化]
E --> F[设置 supportedLngs: locales]
E --> G[设置 fallbackLng: defaultLocale]
E --> H[设置 lng: 传入的语言参数]
E --> I[设置 defaultNS: "basic"]
E --> J[设置 ns: 传入的命名空间]
J --> K[返回已初始化的 i18n 实例]
```

**Diagram sources**
- [app/i18n/index.ts](file://app/i18n/index.ts#L16-L39)

### supportedLngs 与 fallbackLng

`supportedLngs` 配置项直接引用了 `config.ts` 中的 `locales` 数组。它定义了应用正式支持的语言列表。任何不在这个列表中的语言代码请求都将被视为无效，i18next 会自动回退到 `fallbackLng` 指定的语言。

`fallbackLng` 配置项引用了 `config.ts` 中的 `defaultLocale` 常量。当用户请求的语言不被支持，或者在某些情况下无法确定用户语言时，`fallbackLng` 确保了应用总能有一个安全的备选语言进行渲染，保证了用户体验的连续性。

### defaultNS 与命名空间

`defaultNS` 配置项被硬编码为 `"basic"`。命名空间（Namespace）是 i18next 中组织翻译资源的一种方式，允许将不同模块或功能的翻译文本分离到不同的文件中。`defaultNS` 指定了当没有明确指定命名空间时，默认使用的命名空间。这意味着，对于大多数基础的、通用的翻译文本，它们都存储在 `basic.json` 文件中。

**Section sources**
- [app/i18n/index.ts](file://app/i18n/index.ts#L30-L35)

## 服务端翻译函数使用

`app/i18n/index.ts` 文件导出了 `useTranslation` 函数，这是在服务端组件（Server Component）中进行文本翻译的主要方式。

该函数的调用方式如下：`const { t } = await useTranslation(lng, ns)`。它接收一个语言代码 `lng`（例如从路由参数 `[lng]` 获取）和可选的命名空间 `ns`，然后内部调用 `initI18next` 函数来获取一个配置好的 i18n 实例。

函数返回一个对象，其中包含 `t` 函数。`t` 函数是实际的翻译函数，它接收一个键（key）作为参数，并返回该键在当前语言和命名空间下的翻译文本。例如，`t('new')` 在中文环境下会返回 `"+"`，在英文环境下会返回 `"new"`。

**Section sources**
- [app/i18n/index.ts](file://app/i18n/index.ts#L41-L52)

## 预加载策略与性能优化

除了服务端的 `initI18next`，项目还在客户端的 `app/i18n/client.ts` 文件中配置了 i18next。其中一项关键的性能优化是 `preload` 配置。

在客户端的 `init()` 配置中，`preload` 项被设置为 `runsOnServerSide ? locales : []`。这是一个巧妙的策略：
- 在**服务端**（`runsOnServerSide` 为 `true`），`preload` 被设置为 `[]`，即不预加载任何资源。因为服务端是按需加载，只为当前请求的语言加载资源，这避免了不必要的文件读取，优化了服务器性能。
- 在**客户端**，`preload` 被设置为完整的 `locales` 数组。这意味着当应用在浏览器中启动时，i18next 会预先加载所有支持语言（zh 和 en）的 `basic.json` 等核心资源文件。

这种策略极大地优化了首次渲染后的用户体验。当用户首次访问应用时，所有语言的翻译资源已经缓存在浏览器中。用户在切换语言时，无需再发起网络请求去获取新的翻译文件，从而实现了近乎即时的语言切换，显著提升了应用的响应速度和流畅度。

**Section sources**
- [app/i18n/client.ts](file://app/i18n/client.ts#L36-L37)