# 目录结构详解

<cite>
**本文档中引用的文件**  
- [layout.tsx](file://app/[lng]/layout.tsx)
- [index.ts](file://app/i18n/index.ts)
- [Sidebar.tsx](file://components/Sidebar.tsx)
- [NoteEditor.tsx](file://components/NoteEditor.tsx)
- [redis.ts](file://lib/redis.ts)
- [types.ts](file://lib/types.ts)
- [globals.css](file://public/globals.css)
- [middleware.ts](file://middleware.ts)
- [config.ts](file://config.ts)
</cite>

## 目录结构

本项目采用模块化设计，各目录职责清晰，便于维护与扩展。整体结构如下：

```
.
├── app                 # Next.js 应用主入口，包含页面和布局
│   ├── [lng]           # 动态路由段，实现多语言支持
│   └── i18n            # 国际化配置模块
├── components          # 可复用的UI组件集合
├── lib                 # 工具函数与类型定义
├── public              # 静态资源文件
├── middleware.ts       # 中间件，处理语言自动匹配
├── config.ts           # 配置文件，定义语言列表
└── 其他配置文件        # 项目构建与依赖管理配置
```

### app/ 目录：应用主入口与多语言路由

`app/` 是 Next.js 13+ 应用的核心目录，采用 App Router 架构。其中 `[lng]` 为动态路由段，用于支持多语言功能。

`[lng]/layout.tsx` 定义了应用的整体布局结构，通过 `generateStaticParams` 预生成 `zh` 和 `en` 两种语言的静态页面，提升性能。布局中引入 `Sidebar` 组件并传递当前语言参数 `lng`，实现语言上下文的传递。

`[lng]/page.tsx` 和嵌套路由（如 `note/[id]/page.tsx`）共同构成页面层级，所有页面均受 `[lng]` 路由控制，确保 URL 路径与语言绑定。

**Section sources**
- [layout.tsx](file://app/[lng]/layout.tsx#L1-L40)

### i18n/ 模块：国际化配置封装

`i18n/` 子模块集中管理国际化逻辑。`locales/` 目录下存放 `zh/basic.json` 和 `en/basic.json` 等语言资源文件，按语言分类组织。

`index.ts` 中的 `useTranslation` 函数是国际化核心，异步初始化 `i18next` 实例，并加载对应语言的 JSON 资源。该函数返回 `t` 函数用于文本翻译，`i18n` 实例用于语言切换。

`client.ts` 提供客户端专用的 `useTranslation` 钩子，结合 `useState` 和 `useEffect` 实现语言状态同步与 Cookie 存储，确保用户偏好持久化。

**Section sources**
- [index.ts](file://app/i18n/index.ts#L1-L54)
- [client.ts](file://app/i18n/client.ts#L46-L73)

### components/ 目录：UI组件分层设计

`components/` 目录包含所有可复用的UI组件，采用功能分层设计。

#### Sidebar 系列组件：导航结构

`Sidebar.tsx` 是主侧边栏组件，包含 Logo、搜索框和笔记列表。它通过 `useTranslation(lng)` 获取翻译函数，并渲染 `SidebarSearchField`、`EditButton` 和 `SidebarNoteList` 等子组件。

`SidebarNoteList` 及其子组件（`SidebarNoteItem`, `SidebarNoteItemHeader` 等）构成层级化的笔记导航结构，支持展开/收起、搜索过滤等功能，提供良好的用户体验。

**Section sources**
- [Sidebar.tsx](file://components/Sidebar.tsx#L1-L41)

#### 编辑与预览组件

`NoteEditor.tsx` 实现笔记的编辑功能，采用客户端组件（"use client"）。它接收 `initialTitle` 和 `initialBody` 作为初始值，通过 `useState` 管理标题和内容状态。

组件内部使用 `useActionState` 管理保存和删除操作的状态（`saveState`, `deleteState`），并渲染 `SaveButton` 和 `DeleteButton`。右侧区域实时预览 Markdown 内容，通过 `NotePreview` 组件展示。

**Section sources**
- [NoteEditor.tsx](file://components/NoteEditor.tsx#L1-L93)

#### 按钮类组件：交互逻辑封装

`SaveButton.tsx` 和 `DeleteButton.tsx` 封装了表单提交的交互逻辑。它们接收 `saveFormAction` 或 `deleteFormAction` 作为动作函数，以及 `isSaving` 或 `isDeleting` 作为加载状态，实现按钮的禁用、加载动画和错误提示。

这些组件通过隐藏的 `input` 字段传递表单数据，与服务端操作（`actions.ts`）紧密配合，实现无刷新的数据更新。

**Section sources**
- [SaveButton.tsx](file://components/SaveButton.tsx#L1-L2)
- [DeleteButton.tsx](file://components/DeleteButton.tsx#L1-L2)

### lib/ 目录：核心逻辑与类型定义

`lib/` 目录存放与业务逻辑紧密相关的工具和类型。

#### redis.ts：Redis操作抽象

`redis.ts` 封装了对 Redis 数据库的所有操作。通过 `ioredis` 客户端，提供了 `getAllNotes`、`addNote`、`updateNote`、`getNote` 和 `delNote` 等异步函数。

这些函数以 Promise 形式返回数据，将原始的 Redis 哈希结构（`notes`）转换为结构化的 `Notes` 对象，屏蔽了底层存储细节，为上层组件提供简洁的 API。

**Section sources**
- [redis.ts](file://lib/redis.ts#L1-L46)

#### types.ts：类型定义

`types.ts` 定义了项目中的核心数据类型。`NoteData` 接口描述单个笔记的结构（标题、内容、更新时间）。`Notes` 接口表示 Redis 哈希的结构，键为 UUID，值为 JSON 字符串。

`ParsedNote` 用于解析后的笔记数据，`SidebarNoteItemProps` 和 `NoteListProps` 则定义了组件的属性类型，增强代码的可维护性和类型安全。

**Section sources**
- [types.ts](file://lib/types.ts#L1-L30)

### 样式与配置

`public/globals.css` 提供全局样式基础，包含 CSS Reset、根变量（颜色、字体）、通用类（按钮、骨架屏）和组件特定样式（`.sidebar`, `.note-editor`）。样式采用 BEM 命名法，结构清晰。

`middleware.ts` 实现语言自动匹配。通过 `negotiator` 解析请求头中的 `accept-language`，使用 `intl-localematcher` 匹配最合适的语言。若 URL 无语言前缀，则重定向到默认语言（`zh`）或匹配的语言。

`config.ts` 定义了 `locales`（支持的语言列表）和 `defaultLocale`（默认语言），为整个应用提供统一的配置入口，便于维护和扩展。

**Section sources**
- [globals.css](file://public/globals.css#L1-L693)
- [middleware.ts](file://middleware.ts#L1-L50)
- [config.ts](file://config.ts#L1-L3)

```mermaid
graph TD
A[app/] --> B[[[lng]]]
A --> C[i18n/]
B --> D[layout.tsx]
B --> E[page.tsx]
C --> F[locales/]
C --> G[index.ts]
C --> H[client.ts]
D --> I[components/Sidebar]
I --> J[components/SidebarNoteList]
I --> K[components/SidebarSearchField]
I --> L[components/EditButton]
D --> M[components/NoteEditor]
M --> N[components/NotePreview]
M --> O[components/SaveButton]
M --> P[components/DeleteButton]
Q[lib/] --> R[redis.ts]
Q --> S[types.ts]
R --> T[(Redis)]
U[config.ts] --> V[locales, defaultLocale]
W[middleware.ts] --> V
W --> X[语言自动匹配]
D --> Y[public/globals.css]
style A fill:#f9f,stroke:#333
style Q fill:#f9f,stroke:#333
style U fill:#ccf,stroke:#333
style W fill:#ccf,stroke:#333
style Y fill:#ccf,stroke:#333
```

**Diagram sources**
- [layout.tsx](file://app/[lng]/layout.tsx)
- [index.ts](file://app/i18n/index.ts)
- [Sidebar.tsx](file://components/Sidebar.tsx)
- [NoteEditor.tsx](file://components/NoteEditor.tsx)
- [redis.ts](file://lib/redis.ts)
- [types.ts](file://lib/types.ts)
- [globals.css](file://public/globals.css)
- [middleware.ts](file://middleware.ts)
- [config.ts](file://config.ts)